<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProViz — Protein Analysis Suite</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=JetBrains+Mono:wght@300;400;500&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://3Dmol.org/build/3Dmol-min.js"></script>
<style>
  :root {
    --bg: #070710;
    --bg2: #0d0d1a;
    --surface: rgba(255,255,255,0.03);
    --border: rgba(0,200,255,0.12);
    --blue: #00c8ff;
    --blue2: #0066ff;
    --green: #00ff88;
    --purple: #7b2fff;
    --text: #e0e8ff;
    --muted: #4a5580;
    --grid: rgba(0,200,255,0.04);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  html { scroll-behavior: smooth; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-weight: 300;
    overflow-x: hidden;
  }

  /* Grid overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--grid) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  /* SCANLINE */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.08) 2px,
      rgba(0,0,0,0.08) 4px
    );
    pointer-events: none;
    z-index: 0;
  }

  /* NAV */
  nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 48px;
    background: rgba(7,7,16,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
  }

  .nav-logo {
    font-family: 'Orbitron', monospace;
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 3px;
    color: var(--blue);
    text-shadow: 0 0 20px rgba(0,200,255,0.6);
  }

  .nav-logo span { color: var(--green); }

  .nav-links {
    display: flex;
    gap: 32px;
    list-style: none;
  }

  .nav-links a {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.3s;
  }

  .nav-links a:hover { color: var(--blue); }

  .nav-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    padding: 6px 14px;
    border: 1px solid var(--blue);
    color: var(--blue);
    letter-spacing: 2px;
    text-transform: uppercase;
    background: rgba(0,200,255,0.05);
  }

  /* SEARCH COMPONENT STYLES */
  .search-terminal {
    padding: 0 24px 24px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
  }
  .search-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 10px;
    display: block;
  }
  .search-row {
    display: flex;
    gap: 8px;
  }
  #pdb-search-input {
    flex: 1;
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    padding: 10px 12px;
    color: var(--blue);
    font-family: 'Orbitron', sans-serif;
    font-size: 14px;
    outline: none;
    transition: border-color 0.3s;
  }
  #pdb-search-input:focus {
    border-color: var(--blue);
    box-shadow: 0 0 15px rgba(0,200,255,0.15);
  }
  .search-go-btn {
    background: var(--blue);
    border: none;
    color: #000;
    padding: 0 15px;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    cursor: pointer;
    clip-path: polygon(10% 0%, 100% 0%, 90% 100%, 0% 100%);
    transition: background 0.3s;
  }
  .search-go-btn:hover {
    background: var(--green);
  }

  /* HERO */
  #hero {
    position: relative;
    height: 100vh;
    display: flex;
    align-items: center;
    overflow: hidden;
    z-index: 1;
  }

  #viewer-container {
    position: absolute;
    right: 60px;
    top: 50%;
    transform: translateY(-50%);
    width: 520px;
    height: 520px;
    z-index: 1;
    pointer-events: none;
    /* Soft edge fade so it blends seamlessly into the dark background */
    mask-image: radial-gradient(ellipse 85% 85% at 55% 50%, black 45%, transparent 100%);
    -webkit-mask-image: radial-gradient(ellipse 85% 85% at 55% 50%, black 45%, transparent 100%);
    opacity: 0.88;
  }

  .hero-content {
    position: relative;
    z-index: 2;
    padding: 0 80px;
    max-width: 680px;
  }

  .hero-tag {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 4px;
    color: var(--green);
    text-transform: uppercase;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .hero-tag::before {
    content: '';
    width: 40px;
    height: 1px;
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
  }

  h1 {
    font-family: 'Orbitron', monospace;
    font-size: clamp(36px, 5vw, 68px);
    font-weight: 900;
    line-height: 1.05;
    letter-spacing: -1px;
    margin-bottom: 24px;
  }

  h1 .glow { color: var(--blue); text-shadow: 0 0 40px rgba(0,200,255,0.8), 0 0 80px rgba(0,200,255,0.3); }
  h1 .dim { color: rgba(255,255,255,0.5); }

  .hero-desc {
    font-size: 15px;
    line-height: 1.8;
    color: rgba(224,232,255,0.6);
    margin-bottom: 40px;
    max-width: 500px;
  }

  .hero-cta {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }

  .btn-primary {
    padding: 14px 32px;
    background: var(--blue);
    color: #000;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    clip-path: polygon(8px 0%, 100% 0%, calc(100% - 8px) 100%, 0% 100%);
    transition: all 0.3s;
  }

  .btn-primary:hover { background: var(--green); box-shadow: 0 0 30px rgba(0,255,136,0.4); }

  .btn-ghost {
    padding: 14px 32px;
    background: transparent;
    color: var(--blue);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    border: 1px solid var(--blue);
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s;
  }

  .btn-ghost:hover { background: rgba(0,200,255,0.08); }

  /* HERO STATS */
  .hero-stats {
    position: absolute;
    bottom: 48px;
    right: 80px;
    z-index: 2;
    display: flex;
    gap: 32px;
  }

  .stat {
    text-align: right;
    border-right: 1px solid var(--border);
    padding-right: 24px;
  }

  .stat:last-child { border-right: none; padding-right: 0; }

  .stat-num {
    font-family: 'Orbitron', monospace;
    font-size: 28px;
    font-weight: 700;
    color: var(--blue);
    text-shadow: 0 0 20px rgba(0,200,255,0.5);
  }

  .stat-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
    margin-top: 4px;
  }

  /* SECTION */
  section {
    position: relative;
    z-index: 1;
    padding: 100px 80px;
  }

  .section-tag {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 4px;
    color: var(--green);
    text-transform: uppercase;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .section-tag::before {
    content: '//';
    color: var(--muted);
  }

  h2 {
    font-family: 'Orbitron', monospace;
    font-size: clamp(26px, 3vw, 42px);
    font-weight: 700;
    letter-spacing: 1px;
    margin-bottom: 16px;
  }

  h2 .accent { color: var(--blue); }

  .section-sub {
    font-size: 14px;
    color: var(--muted);
    max-width: 480px;
    line-height: 1.7;
    margin-bottom: 60px;
  }

  /* LAYOUT */
  #lab {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 0;
    padding: 0;
    min-height: 100vh;
    background: var(--bg2);
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
  }

  /* SIDEBAR */
  .sidebar {
    background: rgba(255,255,255,0.02);
    border-right: 1px solid var(--border);
    padding: 40px 0;
    position: sticky;
    top: 0;
    height: 100vh;
    overflow-y: auto;
  }

  .sidebar-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
    padding: 0 24px 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
  }

  .pdb-item {
    padding: 12px 24px;
    cursor: pointer;
    border-left: 2px solid transparent;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .pdb-item:hover, .pdb-item.active {
    background: rgba(0,200,255,0.05);
    border-left-color: var(--blue);
  }

  .pdb-id {
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    font-weight: 600;
    color: var(--blue);
  }

  .pdb-item.active .pdb-id { text-shadow: 0 0 10px rgba(0,200,255,0.5); }

  .pdb-name {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.5px;
  }

  .pdb-type {
    font-size: 9px;
    color: var(--green);
    font-family: 'JetBrains Mono', monospace;
    opacity: 0.7;
  }

  /* LAB MAIN */
  .lab-main {
    padding: 40px;
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .lab-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .lab-title-area h3 {
    font-family: 'Orbitron', monospace;
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
  }

  .lab-title-area p {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
    margin-top: 6px;
  }

  .view-controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .view-btn {
    padding: 8px 20px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .view-btn.active, .view-btn:hover {
    border-color: var(--blue);
    color: var(--blue);
    background: rgba(0,200,255,0.05);
    box-shadow: 0 0 12px rgba(0,200,255,0.1);
  }

  /* 3D VIEWER */
  #lab-viewer {
    width: 100%;
    height: 500px;
    background: radial-gradient(ellipse at center, #0a0a1f 0%, var(--bg) 100%);
    border: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }

  #lab-viewer-canvas {
    width: 100%;
    height: 100%;
  }

  .viewer-overlay {
    position: absolute;
    top: 16px;
    right: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .viewer-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    padding: 6px 12px;
    background: rgba(0,0,0,0.7);
    border: 1px solid var(--border);
    color: var(--muted);
    backdrop-filter: blur(10px);
  }

  .viewer-badge span { color: var(--blue); }

  .loading-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(7,7,16,0.9);
    z-index: 10;
    gap: 16px;
  }

  .loading-spinner {
    width: 48px;
    height: 48px;
    border: 2px solid var(--border);
    border-top-color: var(--blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }

  /* CONTROLS PANEL */
  .controls-panel {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .control-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 20px;
  }

  .control-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 14px;
  }

  .slider-container {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  input[type="range"] {
    flex: 1;
   -webkit-appearance: none;
  appearance: none; /* Add this line to clear the warning */
  background: transparent;
  cursor: pointer;
    height: 2px;
    background: var(--border);
    outline: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    background: var(--blue);
    cursor: pointer;
    box-shadow: 0 0 10px rgba(0,200,255,0.5);
  }

  .slider-val {
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    color: var(--blue);
    min-width: 40px;
    text-align: right;
  }

  .download-btn {
    width: 100%;
    padding: 12px;
    background: rgba(0,255,136,0.05);
    border: 1px solid rgba(0,255,136,0.2);
    color: var(--green);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .download-btn:hover {
    background: rgba(0,255,136,1);
    box-shadow: 0 0 20px rgba(0,255,136,0.15);
  }

  /* TOOL MATRIX */
  #tools {
    background: var(--bg);
  }

  .matrix-container {
    overflow-x: auto;
  }

  .glass-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    backdrop-filter: blur(20px);
  }

  .glass-table th {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    padding: 20px 32px;
    text-align: left;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
    background: rgba(0,200,255,0.03);
  }

  .glass-table th:first-child {
    color: var(--blue);
    font-size: 11px;
  }

  .glass-table td {
    padding: 20px 32px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    font-size: 13px;
    line-height: 1.5;
    vertical-align: top;
  }

  .glass-table tr:last-child td { border-bottom: none; }

  .glass-table tbody tr {
    transition: background 0.2s;
  }

  .glass-table tbody tr:hover {
    background: rgba(0,200,255,0.03);
  }

  .tool-name {
    font-family: 'Orbitron', monospace;
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
  }

  .tool-ver {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
  }

  .rating {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .dots {
    display: flex;
    gap: 4px;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border);
  }

  .dot.fill { background: var(--blue); box-shadow: 0 0 6px rgba(0,200,255,0.5); }
  .dot.fill.green { background: var(--green); box-shadow: 0 0 6px rgba(0,255,136,0.5); }
  .dot.fill.purple { background: var(--purple); box-shadow: 0 0 6px rgba(123,47,255,0.5); }

  .rating-num {
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    color: var(--muted);
  }

  .tag {
    display: inline-block;
    padding: 3px 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    border: 1px solid;
    margin: 2px;
  }

  .tag.blue { border-color: rgba(0,200,255,0.3); color: var(--blue); background: rgba(0,200,255,0.05); }
  .tag.green { border-color: rgba(0,255,136,0.3); color: var(--green); background: rgba(0,255,136,0.05); }
  .tag.purple { border-color: rgba(123,47,255,0.3); color: var(--purple); background: rgba(123,47,255,0.05); }

  /* FOLDING ANIMATION */
  #folding {
    background: linear-gradient(180deg, var(--bg) 0%, var(--bg2) 50%, var(--bg) 100%);
    text-align: center;
  }

  .folding-canvas-wrap {
    position: relative;
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .fold-svg {
    width: 100%;
    height: 100%;
  }

  /* Protein chain animation */
  .chain-path {
    fill: none;
    stroke-width: 3;
    stroke-linecap: round;
  }

  .chain-1 { stroke: var(--blue); animation: chainDraw 4s ease-in-out infinite alternate; }
  .chain-2 { stroke: var(--green); animation: chainDraw 4s ease-in-out 0.5s infinite alternate; }
  .chain-3 { stroke: var(--purple); animation: chainDraw 4s ease-in-out 1s infinite alternate; }

  @keyframes chainDraw {
    0% { stroke-dashoffset: 1200; }
    100% { stroke-dashoffset: 0; }
  }

  .helix {
    animation: helixPulse 3s ease-in-out infinite;
  }

  @keyframes helixPulse {
    0%, 100% { opacity: 0.4; transform: scaleY(1); }
    50% { opacity: 1; transform: scaleY(1.1); }
  }

  .fold-label {
    position: absolute;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .steps-row {
    display: flex;
    justify-content: center;
    gap: 0;
    margin-top: 48px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }

  .step {
    flex: 1;
    padding: 24px 16px;
    text-align: center;
    border-top: 1px solid var(--border);
    border-right: 1px solid var(--border);
    position: relative;
    transition: background 0.3s;
  }

  .step:first-child { border-left: 1px solid var(--border); }

  .step:hover { background: rgba(0,200,255,0.03); }

  .step-num {
    font-family: 'Orbitron', monospace;
    font-size: 36px;
    font-weight: 900;
    color: rgba(0,200,255,0.15);
    line-height: 1;
    margin-bottom: 8px;
  }

  .step-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--blue);
    margin-bottom: 8px;
  }

  .step-desc {
    font-size: 12px;
    color: var(--muted);
    line-height: 1.6;
  }

  /* LEGEND */
  .legend-row {
    display: flex;
    gap: 24px;
    margin-top: 24px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--muted);
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  /* FOOTER */
  footer {
    position: relative;
    z-index: 1;
    padding: 48px 80px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: gap;
    gap: 24px;
  }

  .footer-logo {
    font-family: 'Orbitron', monospace;
    font-size: 16px;
    font-weight: 700;
    color: var(--muted);
    letter-spacing: 3px;
  }

  .footer-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1px;
  }

  /* GLOW ORBS */
  .orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(100px);
    pointer-events: none;
    z-index: 0;
  }

  .orb-1 {
    width: 600px;
    height: 600px;
    background: rgba(0,200,255,0.06);
    top: -200px;
    right: -200px;
  }

  .orb-2 {
    width: 400px;
    height: 400px;
    background: rgba(123,47,255,0.06);
    bottom: -100px;
    left: -100px;
  }

  /* ANIMATIONS */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .hero-content > * {
    animation: fadeUp 0.8s ease forwards;
    opacity: 0;
  }

  .hero-content > *:nth-child(1) { animation-delay: 0.2s; }
  .hero-content > *:nth-child(2) { animation-delay: 0.4s; }
  .hero-content > *:nth-child(3) { animation-delay: 0.6s; }
  .hero-content > *:nth-child(4) { animation-delay: 0.8s; }

  /* PULSE BORDER */
  @keyframes pulseBorder {
    0%, 100% { opacity: 0.12; }
    50% { opacity: 0.3; }
  }

  .pulse-border {
    animation: pulseBorder 3s ease-in-out infinite;
  }

  /* ===========================
     INTERACTIVE FOLDING LAB CSS
     =========================== */
  #folding {
    background: linear-gradient(180deg, var(--bg) 0%, #080820 50%, var(--bg) 100%);
    padding: 100px 60px;
  }

  /* Controls */
  .flab-controls {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 40px;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    padding: 28px 32px;
  }

  .flab-scrubber-wrap {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .flab-scrubber-labels {
    display: flex;
    justify-content: space-between;
  }

  .scrub-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    transition: color 0.3s;
  }

  .scrub-label.active {
    color: var(--blue);
    text-shadow: 0 0 10px rgba(0,200,255,0.5);
  }

  .flab-scrubber-track {
    position: relative;
    height: 4px;
    background: var(--border);
  }

  .flab-scrubber-fill {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 0%;
    background: linear-gradient(90deg, var(--blue2), var(--blue), var(--green));
    box-shadow: 0 0 12px rgba(0,200,255,0.4);
    transition: width 0.05s;
    pointer-events: none;
  }

  #foldScrubber {
    position: absolute;
    inset: -10px 0;
    width: 100%;
    height: 24px;
   -webkit-appearance: none;
  appearance: none; /* Add this line to clear the warning */
  background: transparent;
  cursor: pointer;
    background: transparent;
    cursor: pointer;
  }

  #foldScrubber::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--blue);
    border: 2px solid #fff;
    cursor: pointer;
    box-shadow: 0 0 20px rgba(0,200,255,0.8);
    transition: background 0.3s;
  }

  .flab-scrubber-val {
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    color: var(--blue);
    text-align: right;
  }

  .flab-btn-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .flab-btn {
    padding: 10px 20px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    border: 1px solid;
    cursor: pointer;
    transition: all 0.25s;
    background: transparent;
  }

  .flab-btn-play {
    border-color: var(--blue);
    color: var(--blue);
  }
  .flab-btn-play:hover, .flab-btn-play.playing {
    background: rgba(0,200,255,0.1);
    box-shadow: 0 0 20px rgba(0,200,255,0.2);
  }

  .flab-btn-chap {
    border-color: var(--green);
    color: var(--green);
  }
  .flab-btn-chap.off {
    border-color: #ff6644;
    color: #ff6644;
  }
  .flab-btn-chap:hover { background: rgba(0,255,136,0.07); }

  .flab-btn-mut {
    border-color: #ff4444;
    color: #ff4444;
  }
  .flab-btn-mut:hover { background: rgba(255,68,68,0.08); box-shadow: 0 0 20px rgba(255,68,68,0.2); }

  .flab-btn-xray {
    border-color: var(--purple);
    color: var(--purple);
  }
  .flab-btn-xray.on {
    background: rgba(123,47,255,0.15);
    box-shadow: 0 0 20px rgba(123,47,255,0.3);
  }

  .flab-btn-reset {
    border-color: var(--muted);
    color: var(--muted);
  }
  .flab-btn-reset:hover { border-color: var(--text); color: var(--text); }

  /* MAIN GRID */
  .flab-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 24px;
    align-items: start;
  }

  /* Canvas */
  .flab-canvas-wrap {
    position: relative;
    background: radial-gradient(ellipse at center, #0a0a2a 0%, #050510 100%);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  #foldCanvas {
    display: block;
    width: 100%;
    height: auto;
  }

  .flab-phase-badge {
    position: absolute;
    top: 16px;
    left: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(0,0,0,0.75);
    border: 1px solid var(--border);
    padding: 8px 16px;
    backdrop-filter: blur(10px);
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text);
  }

  .phase-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--blue);
    box-shadow: 0 0 8px rgba(0,200,255,0.8);
    animation: phasePulse 1.5s ease-in-out infinite;
  }

  @keyframes phasePulse {
    0%,100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.4); opacity: 0.6; }
  }

  /* Tooltip */
  .flab-tooltip {
    position: absolute;
    top: 60px;
    right: 16px;
    max-width: 200px;
    background: rgba(0,5,20,0.92);
    border: 1px solid rgba(0,200,255,0.25);
    padding: 14px 16px;
    backdrop-filter: blur(16px);
    opacity: 0;
    pointer-events: none;
    transform: translateY(-6px);
    transition: opacity 0.3s, transform 0.3s;
    box-shadow: 0 0 30px rgba(0,200,255,0.1);
  }

  .flab-tooltip.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .tooltip-title {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    color: var(--blue);
    margin-bottom: 8px;
    letter-spacing: 1px;
  }

  .tooltip-body {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    line-height: 1.6;
  }

  /* X-Ray overlay */
  .xray-overlay {
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at center, transparent 30%, rgba(7,7,16,0.85) 100%);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.5s;
  }

  .xray-overlay.active { opacity: 1; }

  /* Mutation banner */
  .mutation-banner {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    background: rgba(200,0,0,0.85);
    color: #fff;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    text-align: center;
    padding: 10px;
    transform: translateY(100%);
    transition: transform 0.4s;
  }

  .mutation-banner.visible { transform: translateY(0); }

  /* Side Panels */
  .flab-panels {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .flab-panel {
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    padding: 20px;
  }

  .panel-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
  }

  .energy-canvas-wrap {
    width: 100%;
    overflow: hidden;
  }

  #energyCanvas {
    width: 100%;
    height: auto;
    display: block;
  }

  .energy-legend {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    color: var(--muted);
    margin-top: 8px;
    letter-spacing: 1px;
  }

  /* Diagnostics grid */
  .diag-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .diag-item {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(0,200,255,0.06);
    padding: 10px 12px;
  }

  .diag-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 8px;
    letter-spacing: 1px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .diag-val {
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    color: var(--blue);
    font-weight: 600;
  }

  /* Hint panel */
  .flab-hint { border-color: rgba(123,47,255,0.15); }

  .hint-list { display: flex; flex-direction: column; gap: 8px; }

  .hint-item {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .hint-key {
    color: var(--purple);
    border: 1px solid rgba(123,47,255,0.3);
    padding: 2px 7px;
    font-size: 9px;
    white-space: nowrap;
  }

  /* MOBILE */
  @media (max-width: 900px) {
    nav { padding: 16px 24px; }
    .nav-links { display: none; }
    section { padding: 60px 24px; }
    .hero-content { padding: 0 24px; }
    .hero-stats { right: 24px; bottom: 32px; gap: 16px; }
    .stat-num { font-size: 20px; }
    #lab { grid-template-columns: 1fr; }
    .sidebar { height: auto; position: relative; display: flex; flex-wrap: wrap; padding: 16px; gap: 8px; }
    .pdb-item { width: calc(50% - 4px); padding: 10px 12px; }
    .controls-panel { grid-template-columns: 1fr; }
    footer { padding: 32px 24px; }
    .flab-grid { grid-template-columns: 1fr; }
    #folding { padding: 60px 24px; }
    .flab-btn-row { gap: 8px; }
    .flab-btn { padding: 8px 12px; font-size: 10px; }
    /* Hero viewer: move behind text, smaller, very low opacity on mobile */
    #viewer-container {
      right: auto;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      height: 320px;
      opacity: 0.18;
      z-index: 0;
    }
  }

  /* Notification */
  .notif {
    position: fixed;
    bottom: 32px;
    right: 32px;
    z-index: 9999;
    background: rgba(0,0,0,0.9);
    border: 1px solid var(--green);
    padding: 16px 24px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--green);
    letter-spacing: 1px;
    backdrop-filter: blur(20px);
    transform: translateX(200%);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .notif.show { transform: translateX(0); }
</style>
</head>
<body>

<nav>
  <div class="nav-logo">PRO<span>VIZ</span></div>
  <ul class="nav-links">
    <li><a href="#hero">Overview</a></li>
    <li><a href="#lab">Structure Lab</a></li>
    <li><a href="#tools">Tool Matrix</a></li>
    <li><a href="#folding">Folding</a></li>
  </ul>
  <div class="nav-badge">v2.4.1 — BETA</div>
</nav>

<section id="hero">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div id="viewer-container"></div>
  <div class="hero-content">
    <div class="hero-tag">Structural Bioinformatics Platform</div>
    <h1>
      <span class="dim">The</span><br>
      <span class="glow">Protein</span><br>
      <span class="dim">Analysis Suite</span>
    </h1>
    <p class="hero-desc">
      Real-time 3D molecular visualization powered by PDB data. Explore protein structures, predict secondary folding, and compare visualization tools in one unified interface.
    </p>
    <div class="hero-cta">
      <a href="#lab" class="btn-primary">Open Structure Lab</a>
      <a href="#tools" class="btn-ghost">View Tool Matrix</a>
    </div>
  </div>
  <div class="hero-stats">
    <div class="stat">
      <div class="stat-num">218K+</div>
      <div class="stat-label">PDB Structures</div>
    </div>
    <div class="stat">
      <div class="stat-num">1.4Å</div>
      <div class="stat-label">Max Resolution</div>
    </div>
    <div class="stat">
      <div class="stat-num">6</div>
      <div class="stat-label">View Modes</div>
    </div>
  </div>
</section>

<div id="lab">
  <aside class="sidebar">
    <div class="search-terminal">
      <label class="search-label">Global PDB Search</label>
      <div class="search-row">
        <input type="text" id="pdb-search-input" placeholder="e.g. 6VXX" maxlength="4">
        <button class="search-go-btn" onclick="searchProtein()">GO</button>
      </div>
    </div>

    <div class="sidebar-title">PDB Library</div>

    <div class="pdb-item active" data-pdb="1A3N" onclick="loadProtein('1A3N', this)">
      <div class="pdb-id">1A3N</div>
      <div class="pdb-name">Hemoglobin</div>
      <div class="pdb-type">Oxygen Transport</div>
    </div>

    <div class="pdb-item" data-pdb="1HHO" onclick="loadProtein('1HHO', this)">
      <div class="pdb-id">1HHO</div>
      <div class="pdb-name">Oxyhemoglobin</div>
      <div class="pdb-type">Metalloprotein</div>
    </div>

    <div class="pdb-item" data-pdb="1MBO" onclick="loadProtein('1MBO', this)">
      <div class="pdb-id">1MBO</div>
      <div class="pdb-name">Myoglobin</div>
      <div class="pdb-type">Heme Protein</div>
    </div>

    <div class="pdb-item" data-pdb="2LYZ" onclick="loadProtein('2LYZ', this)">
      <div class="pdb-id">2LYZ</div>
      <div class="pdb-name">Lysozyme</div>
      <div class="pdb-type">Enzyme</div>
    </div>

    <div class="pdb-item" data-pdb="1CRN" onclick="loadProtein('1CRN', this)">
      <div class="pdb-id">1CRN</div>
      <div class="pdb-name">Crambin</div>
      <div class="pdb-type">Plant Protein</div>
    </div>

    <div class="pdb-item" data-pdb="4HHB" onclick="loadProtein('4HHB', this)">
      <div class="pdb-id">4HHB</div>
      <div class="pdb-name">Deoxyhemoglobin</div>
      <div class="pdb-type">Allosteric Protein</div>
    </div>

    <div class="pdb-item" data-pdb="1TIM" onclick="loadProtein('1TIM', this)">
      <div class="pdb-id">1TIM</div>
      <div class="pdb-name">Triose Phosphate</div>
      <div class="pdb-type">Isomerase</div>
    </div>

    <div class="pdb-item" data-pdb="1AKI" onclick="loadProtein('1AKI', this)">
      <div class="pdb-id">1AKI</div>
      <div class="pdb-name">Lysozyme C</div>
      <div class="pdb-type">Antimicrobial</div>
    </div>
  </aside>

  <div class="lab-main">
    <div class="lab-header">
      <div class="lab-title-area">
        <h3 id="current-protein-name">Hemoglobin</h3>
        <p id="current-pdb-id">PDB ID: 1A3N — Loaded from RCSB</p>
      </div>
      <div class="view-controls">
        <button class="view-btn active" onclick="setStyle('cartoon')">Cartoon</button>
        <button class="view-btn" onclick="setStyle('surface')">Surface</button>
        <button class="view-btn" onclick="setStyle('stick')">Stick</button>
        <button class="view-btn" onclick="setStyle('sphere')">Sphere</button>
      </div>
    </div>

    <div id="lab-viewer">
      <div id="lab-viewer-canvas"></div>
      <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading PDB Data...</div>
      </div>
      <div class="viewer-overlay">
        <div class="viewer-badge">MODE: <span id="mode-badge">CARTOON</span></div>
        <div class="viewer-badge">PDB: <span id="pdb-badge">1A3N</span></div>
      </div>
    </div>

    <div class="controls-panel">
      <div class="control-card">
        <div class="control-label">Surface Opacity</div>
        <div class="slider-container">
          <input type="range" min="0" max="100" value="80" id="opacity-slider" oninput="updateOpacity(this.value)">
          <div class="slider-val" id="opacity-val">80%</div>
        </div>
      </div>
      <div class="control-card">
        <div class="control-label">Color Scheme</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="view-btn active" onclick="setColorScheme('spectrum')">Spectrum</button>
          <button class="view-btn" onclick="setColorScheme('chain')">Chain</button>
          <button class="view-btn" onclick="setColorScheme('ssJmol')">Secondary</button>
        </div>
      </div>
      <div class="control-card" style="grid-column: 1 / -1;">
        <button class="download-btn" onclick="downloadSnapshot()">
          ⬇ Download High-Res Snapshot
        </button>
      </div>
    </div>

    <div class="legend-row">
      <div class="legend-item"><div class="legend-dot" style="background:#ff4444;"></div>Alpha Helix</div>
      <div class="legend-item"><div class="legend-dot" style="background:#4488ff;"></div>Beta Sheet</div>
      <div class="legend-item"><div class="legend-dot" style="background:#44ffaa;"></div>Loop/Coil</div>
      <div class="legend-item"><div class="legend-dot" style="background:#ffaa00;"></div>Turn</div>
    </div>
  </div>
</div>

<section id="tools">
  <div class="orb orb-1" style="width:400px;height:400px;top:50px;right:0;"></div>
  <div class="section-tag">Comparative Analysis</div>
  <h2>Tool <span class="accent">Matrix</span></h2>
  <p class="section-sub">A comprehensive evaluation of leading protein visualization software across critical research criteria.</p>

  <div class="matrix-container">
    <table class="glass-table">
      <thead>
        <tr>
          <th>Software</th>
          <th>Rendering Quality</th>
          <th>Scripting Capability</th>
          <th>Ease of Use</th>
          <th>Platform</th>
          <th>License</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div class="tool-name">PyMOL</div>
            <div class="tool-ver">v2.5.7 · Schrödinger</div>
          </td>
          <td>
            <div class="rating">
              <div class="dots">
                <div class="dot fill"></div><div class="dot fill"></div><div class="dot fill"></div><div class="dot fill"></div><div class="dot fill"></div>
              </div>
              <span class="rating-num">9.5/10</span>
            </div>
            <div style="margin-top:8px;">
              <span class="tag blue">Ray-Tracing</span>
              <span class="tag blue">4K Export</span>
            </div>
          </td>
          <td>
            <div class="rating">
              <div class="dots">
                <div class="dot fill"></div><div class="dot fill"></div><div class="dot fill"></div><div class="dot fill"></div><div class="dot fill"></div>
              </div>
              <span class="rating-num">9.8/10</span>
            </div>
            <div style="margin-top:8px;">
              <span class="tag blue">Python API</span>
              <span class="tag blue">Batch</span>
            </div>
          </td>
          <td>
            <div class="rating">
              <div class="dots">
                <div class="dot fill"></div><div class="dot fill"></div><div class="dot fill"></div><div class="dot"></div><div class="dot"></div>
              </div>
              <span class="rating-num">6.5/10</span>
            </div>
            <div style="margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);">Steep learning curve</div>
          </td>
          <td>
            <span class="tag blue">Windows</span>
            <span class="tag blue">macOS</span>
            <span class="tag blue">Linux</span>
          </td>
          <td><span class="tag blue">Open + Commercial</span></td>
        </tr>

        <tr>
          <td>
            <div class="tool-name">UCSF Chimera</div>
            <div class="tool-ver">v1.17 · UCSF</div>
          </td>
          <td>
            <div class="rating">
              <div class="dots">
                <div class="dot fill green"></div><div class="dot fill green"></div><div class="dot fill green"></div><div class="dot fill green"></div><div class="dot"></div>
              </div>
              <span class="rating-num">8.0/10</span>
            </div>
            <div style="margin-top:8px;">
              <span class="tag green">MSMS Surface</span>
              <span class="tag green">Volumetric</span>
            </div>
          </td>
          <td>
            <div class="rating">
              <div class="dots">
                <div class="dot fill green"></div><div class="dot fill green"></div><div class="dot fill green"></div><div class="dot fill green"></div><div class="dot"></div>
              </div>
              <span class="rating-num">8.5/10</span>
            </div>
            <div style="margin-top:8px;">
              <span class="tag green">Python</span>
              <span class="tag green">RESTful</span>
            </div>
          </td>
          <td>
            <div class="rating">
              <div class="dots">
                <div class="dot fill green"></div><div class="dot fill green"></div><div class="dot fill green"></div><div class="dot fill green"></div><div class="dot"></div>
              </div>
              <span class="rating-num">7.5/10</span>
            </div>
            <div style="margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);">Good GUI + docs</div>
          </td>
          <td>
            <span class="tag green">Windows</span>
            <span class="tag green">macOS</span>
            <span class="tag green">Linux</span>
          </td>
          <td><span class="tag green">Free Academic</span></td>
        </tr>

        <tr>
          <td>
            <div class="tool-name">RasMol</div>
            <div class="tool-ver">v2.7.5 · Classic</div>
          </td>
          <td>
            <div class="rating">
              <div class="dots">
                <div class="dot fill purple"></div><div class="dot fill purple"></div><div class="dot fill purple"></div><div class="dot"></div><div class="dot"></div>
              </div>
              <span class="rating-num">5.5/10</span>
            </div>
            <div style="margin-top:8px;">
              <span class="tag purple">Basic Rendering</span>
              <span class="tag purple">Legacy</span>
            </div>
          </td>
          <td>
            <div class="rating">
              <div class="dots">
                <div class="dot fill purple"></div><div class="dot fill purple"></div><div class="dot fill purple"></div><div class="dot"></div><div class="dot"></div>
              </div>
              <span class="rating-num">5.0/10</span>
            </div>
            <div style="margin-top:8px;">
              <span class="tag purple">RasMol Script</span>
            </div>
          </td>
          <td>
            <div class="rating">
              <div class="dots">
                <div class="dot fill purple"></div><div class="dot fill purple"></div><div class="dot fill purple"></div><div class="dot fill purple"></div><div class="dot fill purple"></div>
              </div>
              <span class="rating-num">9.0/10</span>
            </div>
            <div style="margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);">Best for beginners</div>
          </td>
          <td>
            <span class="tag purple">Windows</span>
            <span class="tag purple">macOS</span>
          </td>
          <td><span class="tag purple">Open Source</span></td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<section id="folding">

  <div style="text-align:center;margin-bottom:48px;">
    <div class="section-tag" style="justify-content:center;">Interactive Simulation</div>
    <h2>Protein <span class="accent">Folding Lab</span></h2>
    <p class="section-sub" style="margin-left:auto;margin-right:auto;text-align:center;">
      Scrub through every folding stage, toggle chaperones, trigger mutations, and watch thermodynamics unfold in real-time.
    </p>
  </div>

  <div class="flab-controls">
    <div class="flab-scrubber-wrap">
      <div class="flab-scrubber-labels">
        <span class="scrub-label active" data-phase="0">Primary</span>
        <span class="scrub-label" data-phase="25">Secondary</span>
        <span class="scrub-label" data-phase="50">Tertiary</span>
        <span class="scrub-label" data-phase="75">Collapse</span>
        <span class="scrub-label" data-phase="100">Native</span>
      </div>
      <div class="flab-scrubber-track">
        <div class="flab-scrubber-fill" id="scrubFill"></div>
        <input type="range" min="0" max="100" value="0" id="foldScrubber" oninput="onScrub(this.value)">
      </div>
      <div class="flab-scrubber-val"><span id="scrubPct">0</span>% Folded</div>
    </div>

    <div class="flab-btn-row">
      <button class="flab-btn flab-btn-play" id="playBtn" onclick="togglePlay()">▶ Auto Play</button>
      <button class="flab-btn flab-btn-chap" id="chapBtn" onclick="toggleChaperone()">⬡ Chaperones: ON</button>
      <button class="flab-btn flab-btn-mut" onclick="triggerMutation()">⚠ Trigger Mutation</button>
      <button class="flab-btn flab-btn-xray" id="xrayBtn" onclick="toggleXray()">◎ X-Ray Vision</button>
      <button class="flab-btn flab-btn-reset" onclick="resetSim()">↺ Reset</button>
    </div>
  </div>

  <div class="flab-grid">

    <div class="flab-canvas-wrap">
      <canvas id="foldCanvas" width="600" height="420"></canvas>

      <div class="flab-phase-badge" id="phaseBadge">
        <span class="phase-dot" id="phaseDot"></span>
        <span id="phaseLabel">PRIMARY STRUCTURE</span>
      </div>

      <div class="flab-tooltip" id="foldTooltip">
        <div class="tooltip-title" id="tooltipTitle">Alpha Helix</div>
        <div class="tooltip-body" id="tooltipBody">Hydrogen bonds form between C=O and N-H groups 4 residues apart, creating the helical backbone.</div>
      </div>

      <div class="xray-overlay" id="xrayOverlay"></div>

      <div class="mutation-banner" id="mutBanner">
        ⚠ MISFOLDING DETECTED — TOXIC AGGREGATE FORMING
      </div>
    </div>

    <div class="flab-panels">

      <div class="flab-panel">
        <div class="panel-title">Gibbs Free Energy Landscape</div>
        <div class="energy-canvas-wrap">
          <canvas id="energyCanvas" width="280" height="200"></canvas>
        </div>
        <div class="energy-legend">
          <span style="color:var(--blue);">■</span> Folding path
          &nbsp;&nbsp;
          <span style="color:var(--green);">●</span> Current state
        </div>
      </div>

      <div class="flab-panel">
        <div class="panel-title">Simulation Diagnostics</div>
        <div class="diag-grid">
          <div class="diag-item">
            <div class="diag-label">Free Energy</div>
            <div class="diag-val" id="diagEnergy">-0.0 kJ/mol</div>
          </div>
          <div class="diag-item">
            <div class="diag-label">H-Bonds</div>
            <div class="diag-val" id="diagHbonds">0</div>
          </div>
          <div class="diag-item">
            <div class="diag-label">Hydrophobic Core</div>
            <div class="diag-val" id="diagCore">0%</div>
          </div>
          <div class="diag-item">
            <div class="diag-label">Stability</div>
            <div class="diag-val" id="diagStable">UNFOLDED</div>
          </div>
          <div class="diag-item">
            <div class="diag-label">Chaperone Status</div>
            <div class="diag-val" id="diagChap" style="color:var(--green);">ACTIVE</div>
          </div>
          <div class="diag-item">
            <div class="diag-label">Mutation</div>
            <div class="diag-val" id="diagMut" style="color:var(--muted);">NONE</div>
          </div>
        </div>
      </div>

      <div class="flab-panel flab-hint">
        <div class="panel-title">Interaction Guide</div>
        <div class="hint-list">
          <div class="hint-item"><span class="hint-key">Hover</span> over helices &amp; sheets for tooltips</div>
          <div class="hint-item"><span class="hint-key">Scrub</span> the timeline to control folding</div>
          <div class="hint-item"><span class="hint-key">Toggle</span> chaperones to see misfolding risk</div>
          <div class="hint-item"><span class="hint-key">X-Ray</span> reveals the hydrophobic core</div>
        </div>
      </div>

    </div>
  </div>

</section>

<footer>
  <div class="footer-logo">PROVIZ</div>
  <div class="footer-text">Protein data sourced from RCSB PDB · 3Dmol.js rendering engine</div>
  <div class="footer-text">© 2025 ProViz Suite · Academic Use</div>
</footer>

<div class="notif" id="notif"></div>

<script>
// ============================================================
// GLOBAL SEARCH ENGINE (ADDED FEATURE)
// ============================================================
async function searchProtein() {
  const input = document.getElementById('pdb-search-input');
  const pdbId = input.value.trim().toUpperCase();

  if (pdbId.length !== 4) {
    return showNotif("⚠ Invalid ID: Use 4 alphanumeric characters.");
  }

  showLoading(true);
  try {
    // 1. Fetch metadata from RCSB to get the real name
    const response = await fetch(`https://data.rcsb.org/rest/v1/core/entry/${pdbId}`);
    if (!response.ok) throw new Error("PDB Not Found");
    const meta = await response.json();
    const scientificName = meta.struct.title || "Unknown Structure";

    // 2. Clear previous selection highlight
    document.querySelectorAll('.pdb-item').forEach(i => i.classList.remove('active'));

    // 3. Update the Lab UI manually for the new search
    currentPDB = pdbId;
    currentName = scientificName;
    document.getElementById('current-protein-name').textContent = scientificName;
    document.getElementById('current-pdb-id').textContent = `PDB ID: ${pdbId} — Fetched via Global Search`;
    document.getElementById('pdb-badge').textContent = pdbId;
    showNotif(`✓ Found: ${scientificName.substring(0, 30)}...`);

    // 4. Load into viewers
    initLabViewer(pdbId);
    if (heroViewer) {
      heroViewer.removeAllModels();
      $3Dmol.download('pdb:' + pdbId, heroViewer, {}, () => {
        heroViewer.setStyle({}, { cartoon: { colorscheme: 'spectrum', opacity: 0.9 }});
        heroViewer.zoomTo();
        heroViewer.spin('y', 0.5);
        heroViewer.render();
      });
    }
  } catch (err) {
    showLoading(false);
    showNotif("⚠ PDB Entry not found in RCSB Database.");
    console.error(err);
  }
}

// Add enter key support for search
document.getElementById('pdb-search-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') searchProtein();
});

// ============================================================
// 3DMOL STRUCTURE LAB
// ============================================================
let heroViewer = null, labViewer = null;
let currentStyle = 'cartoon', currentOpacity = 0.8, currentColorScheme = 'spectrum';
let currentPDB = '1A3N', currentName = 'Hemoglobin';

function showNotif(msg, duration = 3000) {
  const el = document.getElementById('notif');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), duration);
}
function showLoading(show) {
  document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
}

function initHeroViewer(pdbId) {
  pdbId = pdbId || '1A3N';
  const container = document.getElementById('viewer-container');
  container.innerHTML = '';
  // opacity is now handled purely by CSS — no JS opacity override
  try {
    heroViewer = $3Dmol.createViewer(container, { backgroundColor: 'transparent', antialias: true });
    $3Dmol.download('pdb:' + pdbId, heroViewer, {}, () => {
      heroViewer.setStyle({}, { cartoon: { colorscheme: 'spectrum', opacity: 0.9 }});
      heroViewer.zoomTo();
      heroViewer.spin('y', 0.5);  // constant rotation — exhibit mode
      heroViewer.render();
    });
  } catch(e) { console.warn('Hero viewer init failed', e); }
}

function initLabViewer(pdbId) {
  showLoading(true);
  const container = document.getElementById('lab-viewer-canvas');
  container.innerHTML = '';
  try {
    labViewer = $3Dmol.createViewer(container, { backgroundColor: '#050510', antialias: true });
    $3Dmol.download('pdb:' + pdbId, labViewer, {}, () => {
      applyCurrentStyle(); labViewer.zoomTo(); labViewer.render(); showLoading(false);
    });
  } catch(e) {
    fetch(`https://files.rcsb.org/download/${pdbId}.pdb`)
      .then(r => r.text()).then(data => {
        labViewer.addModel(data, 'pdb'); applyCurrentStyle();
        labViewer.zoomTo(); labViewer.render(); showLoading(false);
      }).catch(() => { showLoading(false); showNotif('⚠ Could not load PDB data.'); });
  }
}

function applyCurrentStyle() {
  if (!labViewer) return;
  labViewer.setStyle({}, {});
  const cs = currentColorScheme === 'spectrum' ? 'spectrum' : currentColorScheme === 'chain' ? 'chain' : 'ssJmol';
  if (currentStyle === 'cartoon') {
    labViewer.setStyle({}, { cartoon: { colorscheme: cs, opacity: currentOpacity }});
  } else if (currentStyle === 'surface') {
    labViewer.setStyle({}, { cartoon: { colorscheme: cs, opacity: 0.3 }});
    labViewer.addSurface($3Dmol.SurfaceType.VDW, { opacity: currentOpacity, colorscheme: cs });
  } else if (currentStyle === 'stick') {
    labViewer.setStyle({}, { stick: { colorscheme: cs, radius: 0.15 }});
  } else if (currentStyle === 'sphere') {
    labViewer.setStyle({}, { sphere: { colorscheme: cs, scale: 0.3 }});
  }
  labViewer.render();
}

function setStyle(style) {
  currentStyle = style;
  document.querySelectorAll('.view-controls .view-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('mode-badge').textContent = style.toUpperCase();
  if (labViewer) { labViewer.removeAllSurfaces(); applyCurrentStyle(); }
}
function setColorScheme(scheme) {
  currentColorScheme = scheme;
  document.querySelectorAll('.control-card .view-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  if (labViewer) { labViewer.removeAllSurfaces(); applyCurrentStyle(); }
}
function updateOpacity(val) {
  currentOpacity = val / 100;
  document.getElementById('opacity-val').textContent = val + '%';
  if (labViewer) { labViewer.removeAllSurfaces(); applyCurrentStyle(); }
}
function loadProtein(pdbId, el) {
  document.querySelectorAll('.pdb-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  currentPDB = pdbId; currentName = el.querySelector('.pdb-name').textContent;
  document.getElementById('current-protein-name').textContent = currentName;
  document.getElementById('current-pdb-id').textContent = `PDB ID: ${pdbId} — Loaded from RCSB`;
  document.getElementById('pdb-badge').textContent = pdbId;
  showNotif(`Loading ${currentName} (${pdbId})...`);

  // Sync Lab Viewer
  if (labViewer) { labViewer.removeAllModels(); labViewer.removeAllSurfaces(); }
  initLabViewer(pdbId);

  // Sync Hero Viewer simultaneously — always cartoon + constant spin
  if (heroViewer) {
    heroViewer.removeAllModels();
    $3Dmol.download('pdb:' + pdbId, heroViewer, {}, () => {
      heroViewer.setStyle({}, { cartoon: { colorscheme: 'spectrum', opacity: 0.9 }});
      heroViewer.zoomTo();
      heroViewer.spin('y', 0.5);
      heroViewer.render();
    });
  }
}
function downloadSnapshot() {
  if (!labViewer) return showNotif('⚠ No viewer initialized');
  try {
    const png = labViewer.pngURI();
    const a = document.createElement('a');
    a.href = png; a.download = `proviz_${currentPDB}_${currentStyle}.png`; a.click();
    showNotif(`✓ Snapshot saved: ${currentPDB}_${currentStyle}.png`);
  } catch(e) { showNotif('⚠ Snapshot failed. Try a different browser.'); }
}

// ============================================================
// INTERACTIVE FOLDING LAB ENGINE
// ============================================================
const foldCanvas = document.getElementById('foldCanvas');
const fctx = foldCanvas.getContext('2d');
const energyCanvas = document.getElementById('energyCanvas');
const ectx = energyCanvas.getContext('2d');

// Simulation state
let foldProgress = 0;        // 0-100
let chaperoneOn = true;
let mutationActive = false;
let xrayOn = false;
let isPlaying = false;
let playRaf = null;
let jitterOffset = 0;
let jitterTimer = 0;
let stuckAt = -1;            // where chain "gets stuck" without chaperone
let animTime = 0;
let lastTs = null;

// Spring physics for each amino acid node
const NUM_NODES = 18;
let nodes = [];
let nodeVels = [];

// Define "target" positions for each folding stage
const W = foldCanvas.width, H = foldCanvas.height;
const CX = W / 2, CY = H / 2;

// --- Keyframe positions for 5 phases ---
function getTargetPositions(pct) {
  const t = pct / 100;
  const positions = [];

  if (t < 0.25) {
    // Phase 0-25%: Linear chain
    const lerpT = t / 0.25;
    for (let i = 0; i < NUM_NODES; i++) {
      const linear_x = 80 + (i / (NUM_NODES - 1)) * (W - 160);
      const linear_y = CY;
      // Slight arc hint starting at 25%
      const arcX = CX + Math.cos((i / NUM_NODES) * Math.PI * 1.5 - Math.PI * 0.75) * 220;
      const arcY = CY + Math.sin((i / NUM_NODES) * Math.PI * 1.5 - Math.PI * 0.75) * 100;
      positions.push({
        x: lerp(linear_x, arcX, easeInOut(lerpT) * 0.3),
        y: lerp(linear_y, arcY, easeInOut(lerpT) * 0.3)
      });
    }
  } else if (t < 0.5) {
    // Phase 25-50%: Secondary — helices + sheets forming
    const lerpT = (t - 0.25) / 0.25;
    for (let i = 0; i < NUM_NODES; i++) {
      const frac = i / (NUM_NODES - 1);
      // Helix coil for first half, beta sheet for second half
      let tx, ty;
      if (i < NUM_NODES * 0.55) {
        // Alpha helix: sinusoidal coil around center-left
        const angle = frac * Math.PI * 4;
        tx = CX - 130 + frac * 80 + Math.cos(angle) * 45;
        ty = CY - 60 + Math.sin(angle) * 30;
      } else {
        // Beta sheet: parallel strands
        const row = Math.floor((i - Math.round(NUM_NODES * 0.55)) / 3);
        const col = (i - Math.round(NUM_NODES * 0.55)) % 3;
        tx = CX + 60 + col * 55;
        ty = CY - 40 + row * 55;
      }
      // Blend from linear arc
      const arcX = CX + Math.cos((frac) * Math.PI * 1.5 - Math.PI * 0.75) * 220;
      const arcY = CY + Math.sin((frac) * Math.PI * 1.5 - Math.PI * 0.75) * 100;
      positions.push({
        x: lerp(arcX, tx, easeInOut(lerpT)),
        y: lerp(arcY, ty, easeInOut(lerpT))
      });
    }
  } else if (t < 0.75) {
    // Phase 50-75%: Tertiary — hydrophobic collapse
    const lerpT = (t - 0.5) / 0.25;
    for (let i = 0; i < NUM_NODES; i++) {
      const frac = i / (NUM_NODES - 1);
      // Compact globule positions
      const angle = (i / NUM_NODES) * Math.PI * 2;
      const radius = 50 + (i % 3) * 30;
      const globX = CX + Math.cos(angle) * radius;
      const globY = CY + Math.sin(angle) * radius * 0.7;
      // Blend from secondary structure
      let sx, sy;
      if (i < NUM_NODES * 0.55) {
        const angle2 = frac * Math.PI * 4;
        sx = CX - 130 + frac * 80 + Math.cos(angle2) * 45;
        sy = CY - 60 + Math.sin(angle2) * 30;
      } else {
        const row = Math.floor((i - Math.round(NUM_NODES * 0.55)) / 3);
        const col = (i - Math.round(NUM_NODES * 0.55)) % 3;
        sx = CX + 60 + col * 55;
        sy = CY - 40 + row * 55;
      }
      positions.push({
        x: lerp(sx, globX, easeInOut(lerpT)),
        y: lerp(sy, globY, easeInOut(lerpT))
      });
    }
  } else {
    // Phase 75-100%: Native state — tight globule
    const lerpT = (t - 0.75) / 0.25;
    for (let i = 0; i < NUM_NODES; i++) {
      const frac = i / (NUM_NODES - 1);
      const angle = (i / NUM_NODES) * Math.PI * 2;
      const radius = 50 + (i % 3) * 30;
      const globX = CX + Math.cos(angle) * radius;
      const globY = CY + Math.sin(angle) * radius * 0.7;
      const nativeAngle = (i / NUM_NODES) * Math.PI * 2 + 0.5;
      const nativeR = 30 + (i % 4) * 18;
      const nativeX = CX + Math.cos(nativeAngle) * nativeR;
      const nativeY = CY + Math.sin(nativeAngle) * nativeR * 0.85;
      positions.push({
        x: lerp(globX, nativeX, easeInOut(lerpT)),
        y: lerp(globY, nativeY, easeInOut(lerpT))
      });
    }
  }
  return positions;
}

function lerp(a, b, t) { return a + (b - a) * t; }
function easeInOut(t) { return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t; }

// Node types for coloring/tooltips
const nodeTypes = [
  'helix','helix','helix','helix','helix',
  'sheet','sheet','sheet',
  'coil','coil',
  'helix','helix','helix',
  'sheet','sheet',
  'coil','coil','coil'
];

const typeColors = {
  helix: '#00c8ff',
  sheet: '#00ff88',
  coil:  '#7b2fff'
};
const typeColorsMutated = {
  helix: '#ff3333',
  sheet: '#ff6600',
  coil:  '#cc0066'
};

// Initialize node positions
function initNodes() {
  nodes = [];
  nodeVels = [];
  for (let i = 0; i < NUM_NODES; i++) {
    nodes.push({ x: 80 + (i / (NUM_NODES - 1)) * (W - 160), y: CY });
    nodeVels.push({ x: 0, y: 0 });
  }
}

// Spring physics update
function updateSpring(dt) {
  const targets = getTargetPositions(foldProgress);
  for (let i = 0; i < NUM_NODES; i++) {
    const tx = targets[i].x + jitterOffset * (Math.random() - 0.5) * 2;
    const ty = targets[i].y + jitterOffset * (Math.random() - 0.5) * 2;
    const dx = tx - nodes[i].x;
    const dy = ty - nodes[i].y;
    const stiffness = chaperoneOn ? 12 : 7;
    const damping = chaperoneOn ? 0.75 : 0.6;
    nodeVels[i].x = (nodeVels[i].x + dx * stiffness * dt) * damping;
    nodeVels[i].y = (nodeVels[i].y + dy * stiffness * dt) * damping;
    nodes[i].x += nodeVels[i].x;
    nodes[i].y += nodeVels[i].y;
  }
}

// Hover detection
let hoveredNode = -1;

foldCanvas.addEventListener('mousemove', (e) => {
  const rect = foldCanvas.getBoundingClientRect();
  const scaleX = foldCanvas.width / rect.width;
  const scaleY = foldCanvas.height / rect.height;
  const mx = (e.clientX - rect.left) * scaleX;
  const my = (e.clientY - rect.top) * scaleY;

  let found = -1;
  for (let i = 0; i < NUM_NODES; i++) {
    const dx = nodes[i].x - mx, dy = nodes[i].y - my;
    if (Math.sqrt(dx*dx + dy*dy) < 16) { found = i; break; }
  }
  hoveredNode = found;

  const tt = document.getElementById('foldTooltip');
  if (found >= 0 && foldProgress > 20) {
    const type = nodeTypes[found];
    const titles = {
      helix: 'Alpha Helix',
      sheet: 'Beta Sheet',
      coil: 'Random Coil'
    };
    const bodies = {
      helix: 'H-bonds form between C=O and N-H groups 4 residues apart, stabilizing the spiral backbone at 3.6 residues/turn.',
      sheet: 'Parallel strands aligned via inter-strand H-bonds between backbone amides, forming a pleated planar structure.',
      coil: 'No regular H-bonding pattern. Flexible linker region connecting ordered secondary structure elements.'
    };
    document.getElementById('tooltipTitle').textContent = titles[type];
    document.getElementById('tooltipBody').textContent = bodies[type];
    tt.classList.add('visible');
  } else {
    tt.classList.remove('visible');
  }
});

foldCanvas.addEventListener('mouseleave', () => {
  document.getElementById('foldTooltip').classList.remove('visible');
  hoveredNode = -1;
});

// Draw chain on canvas
function drawChain() {
  fctx.clearRect(0, 0, W, H);

  const t = foldProgress / 100;
  const colors = mutationActive ? typeColorsMutated : typeColors;

  // Background grid dots
  fctx.fillStyle = 'rgba(0,200,255,0.03)';
  for (let x = 0; x < W; x += 40) {
    for (let y = 0; y < H; y += 40) {
      fctx.beginPath();
      fctx.arc(x, y, 1, 0, Math.PI * 2);
      fctx.fill();
    }
  }

  // Hydrophobic core (xray mode or late fold)
  if (t > 0.7) {
    const coreAlpha = xrayOn ? 0.6 : (t - 0.7) / 0.3 * 0.25;
    const coreR = lerp(0, 55, (t - 0.7) / 0.3);
    const grd = fctx.createRadialGradient(CX, CY, 0, CX, CY, coreR);
    grd.addColorStop(0, mutationActive ? `rgba(255,80,0,${coreAlpha})` : `rgba(0,255,136,${coreAlpha})`);
    grd.addColorStop(1, 'transparent');
    fctx.fillStyle = grd;
    fctx.beginPath();
    fctx.arc(CX, CY, coreR, 0, Math.PI * 2);
    fctx.fill();
  }

  // Draw bonds
  fctx.lineCap = 'round';
  for (let i = 0; i < NUM_NODES - 1; i++) {
    const c1 = colors[nodeTypes[i]];
    const c2 = colors[nodeTypes[i+1]];
    const grd = fctx.createLinearGradient(nodes[i].x, nodes[i].y, nodes[i+1].x, nodes[i+1].y);
    grd.addColorStop(0, c1 + 'cc');
    grd.addColorStop(1, c2 + 'cc');

    // Glow
    fctx.shadowColor = c1;
    fctx.shadowBlur = 12;
    fctx.strokeStyle = grd;
    fctx.lineWidth = 3;
    fctx.beginPath();
    fctx.moveTo(nodes[i].x, nodes[i].y);
    fctx.lineTo(nodes[i+1].x, nodes[i+1].y);
    fctx.stroke();
  }

  // H-bond dashed lines (secondary+)
  if (t > 0.25 && t < 0.6) {
    fctx.shadowBlur = 0;
    fctx.setLineDash([4, 6]);
    fctx.strokeStyle = 'rgba(255,255,100,0.25)';
    fctx.lineWidth = 1;
    for (let i = 0; i < NUM_NODES - 4; i++) {
      if (nodeTypes[i] === 'helix' && nodeTypes[i+4] === 'helix') {
        fctx.beginPath();
        fctx.moveTo(nodes[i].x, nodes[i].y);
        fctx.lineTo(nodes[i+4].x, nodes[i+4].y);
        fctx.stroke();
      }
    }
    fctx.setLineDash([]);
  }

  // Draw nodes
  fctx.shadowBlur = 0;
  for (let i = 0; i < NUM_NODES; i++) {
    const c = colors[nodeTypes[i]];
    const r = hoveredNode === i ? 11 : 7;
    const pulse = 1 + Math.sin(animTime * 3 + i * 0.8) * 0.08;

    // Outer glow
    fctx.shadowColor = c;
    fctx.shadowBlur = hoveredNode === i ? 24 : 14;
    fctx.fillStyle = c;
    fctx.beginPath();
    fctx.arc(nodes[i].x, nodes[i].y, r * pulse, 0, Math.PI * 2);
    fctx.fill();

    // Inner white dot
    fctx.shadowBlur = 0;
    fctx.fillStyle = 'rgba(255,255,255,0.8)';
    fctx.beginPath();
    fctx.arc(nodes[i].x, nodes[i].y, 2, 0, Math.PI * 2);
    fctx.fill();
  }

  // Misfolded aggregate blob
  if (mutationActive && t > 0.5) {
    const agg = (t - 0.5) / 0.5;
    fctx.shadowColor = '#ff0000';
    fctx.shadowBlur = 30;
    fctx.fillStyle = `rgba(255,30,30,${agg * 0.12})`;
    fctx.beginPath();
    fctx.arc(CX + 80, CY - 60, 40 * agg, 0, Math.PI * 2);
    fctx.fill();
    fctx.strokeStyle = `rgba(255,60,60,${agg * 0.5})`;
    fctx.lineWidth = 1.5;
    fctx.stroke();
    fctx.shadowBlur = 0;
  }

  // Chaperone molecules (when on, show floating helper blobs)
  if (chaperoneOn && t > 0.1 && t < 0.85) {
    const chapAlpha = 0.4 * Math.sin(animTime * 2) + 0.5;
    fctx.shadowColor = '#00ff88';
    fctx.shadowBlur = 8;
    fctx.strokeStyle = `rgba(0,255,136,${chapAlpha * 0.4})`;
    fctx.lineWidth = 1;
    for (let c = 0; c < 3; c++) {
      const cx = nodes[Math.floor(NUM_NODES * (c + 1) / 4)].x;
      const cy = nodes[Math.floor(NUM_NODES * (c + 1) / 4)].y - 28;
      fctx.beginPath();
      fctx.arc(cx, cy, 10, 0, Math.PI * 2);
      fctx.stroke();
    }
    fctx.shadowBlur = 0;
  }

  fctx.shadowBlur = 0;
}

// Draw energy funnel
function drawEnergy() {
  const EW = energyCanvas.width, EH = energyCanvas.height;
  ectx.clearRect(0, 0, EW, EH);

  // Background
  ectx.fillStyle = 'rgba(0,0,10,0.5)';
  ectx.fillRect(0, 0, EW, EH);

  // Funnel shape: parabola with noise
  const t = foldProgress / 100;

  // Draw funnel curve
  ectx.beginPath();
  const pts = [];
  for (let i = 0; i <= 60; i++) {
    const xFrac = i / 60;
    const funnelX = 20 + xFrac * (EW - 40);
    // Parabolic funnel + rugged landscape
    const funnelY = 20 + Math.pow(Math.abs(xFrac - 0.5) * 2, 1.4) * (EH - 60)
                     + Math.sin(xFrac * 18) * 8
                     + Math.sin(xFrac * 7) * 14;
    pts.push({ x: funnelX, y: funnelY });
  }

  // Fill funnel
  const grd = ectx.createLinearGradient(0, 0, 0, EH);
  grd.addColorStop(0, 'rgba(0,200,255,0.08)');
  grd.addColorStop(1, 'rgba(0,200,255,0.02)');
  ectx.fillStyle = grd;
  ectx.beginPath();
  ectx.moveTo(pts[0].x, 0);
  pts.forEach(p => ectx.lineTo(p.x, p.y));
  ectx.lineTo(pts[pts.length-1].x, 0);
  ectx.closePath();
  ectx.fill();

  // Funnel outline
  ectx.shadowColor = '#00c8ff';
  ectx.shadowBlur = 6;
  ectx.strokeStyle = 'rgba(0,200,255,0.5)';
  ectx.lineWidth = 1.5;
  ectx.beginPath();
  pts.forEach((p, i) => i === 0 ? ectx.moveTo(p.x, p.y) : ectx.lineTo(p.x, p.y));
  ectx.stroke();
  ectx.shadowBlur = 0;

  // Ball rolling down
  const ballXFrac = mutationActive
    ? 0.15 + t * 0.3 + Math.sin(animTime * 4) * 0.06  // stuck in local minimum
    : t * 0.5;  // rolling toward center
  const ballXIdx = Math.min(59, Math.floor(ballXFrac * 60));
  const ballX = pts[ballXIdx].x;
  const ballY = pts[ballXIdx].y - 8;

  // Ball glow
  ectx.shadowColor = mutationActive ? '#ff4444' : '#00ff88';
  ectx.shadowBlur = 16;
  ectx.fillStyle = mutationActive ? '#ff6644' : '#00ff88';
  ectx.beginPath();
  ectx.arc(ballX, ballY, 6, 0, Math.PI * 2);
  ectx.fill();
  ectx.shadowBlur = 0;

  // Axis labels
  ectx.fillStyle = '#4a5580';
  ectx.font = '8px JetBrains Mono';
  ectx.fillText('Unfolded', 8, 15);
  ectx.fillText('Native', EW * 0.45, EH - 6);
  ectx.fillText('ΔG', 4, EH / 2);

  // Energy value readout
  const energyVal = -(t * 42 + Math.sin(animTime * 0.5) * 1.5).toFixed(1);
}

// Update diagnostics panel
function updateDiagnostics() {
  const t = foldProgress / 100;
  const e = -(t * 42).toFixed(1);
  const hb = Math.round(t * 34);
  const core = Math.round(t > 0.7 ? (t - 0.7) / 0.3 * 100 : 0);
  
  const stability = t < 0.1 ? 'UNFOLDED'
    : t < 0.3 ? 'COILING'
    : t < 0.55 ? 'SECONDARY'
    : t < 0.8 ? 'COLLAPSING'
    : mutationActive ? 'MISFOLDED'
    : 'NATIVE';

  const stColor = mutationActive && t > 0.5 ? '#ff4444' : t > 0.8 ? '#00ff88' : '#00c8ff';

  document.getElementById('diagEnergy').textContent = `${e} kJ/mol`;
  document.getElementById('diagHbonds').textContent = hb;
  document.getElementById('diagCore').textContent = `${core}%`;
  document.getElementById('diagStable').style.color = stColor;
  document.getElementById('diagStable').textContent = stability;
  document.getElementById('diagChap').textContent = chaperoneOn ? 'ACTIVE' : 'DISABLED';
  document.getElementById('diagChap').style.color = chaperoneOn ? '#00ff88' : '#ff6644';
  document.getElementById('diagMut').textContent = mutationActive ? 'P→Q MISSENSE' : 'NONE';
  document.getElementById('diagMut').style.color = mutationActive ? '#ff4444' : '#4a5580';
}

// Update phase badge
function updatePhaseBadge() {
  const t = foldProgress / 100;
  const labels = ['PRIMARY STRUCTURE', 'SECONDARY (α-HELIX + β-SHEET)', 'TERTIARY STRUCTURE', 'HYDROPHOBIC COLLAPSE', 'NATIVE STATE'];
  const colors = ['#00c8ff', '#7b2fff', '#00ff88', '#ffaa00', '#00ff88'];
  const idx = t < 0.25 ? 0 : t < 0.5 ? 1 : t < 0.75 ? 2 : t < 0.9 ? 3 : 4;
  
  document.getElementById('phaseLabel').textContent = mutationActive && t > 0.5 ? 'MISFOLDED — AMYLOID AGGREGATE' : labels[idx];
  document.getElementById('phaseDot').style.background = mutationActive && t > 0.5 ? '#ff4444' : colors[idx];
  document.getElementById('phaseDot').style.boxShadow = `0 0 8px ${mutationActive && t > 0.5 ? '#ff4444' : colors[idx]}`;

  // Scrubber labels
  document.querySelectorAll('.scrub-label').forEach(el => {
    const phase = parseInt(el.dataset.phase);
    el.classList.toggle('active', foldProgress >= phase && foldProgress < phase + 25);
    if (phase === 100) el.classList.toggle('active', foldProgress >= 98);
  });
}

// Main animation loop
function animLoop(ts) {
  if (!lastTs) lastTs = ts;
  const dt = Math.min((ts - lastTs) / 1000, 0.05);
  lastTs = ts;
  animTime += dt;

  // Jitter when chaperone is off and mid-fold
  jitterTimer += dt;
  if (!chaperoneOn && foldProgress > 15 && foldProgress < 85) {
    if (jitterTimer > 0.18) {
      jitterOffset = Math.random() * 18;
      jitterTimer = 0;
      // Occasionally get stuck
      if (!stuckAt && Math.random() < 0.05) stuckAt = foldProgress;
    }
  } else {
    jitterOffset = 0;
    stuckAt = -1;
  }

  // Auto-play progression
  if (isPlaying) {
    let speed = chaperoneOn ? 8 : 5;
    if (stuckAt > 0 && Math.abs(foldProgress - stuckAt) < 8) speed = 0.5; // stuck
    foldProgress = Math.min(100, foldProgress + speed * dt);
    document.getElementById('foldScrubber').value = foldProgress;
    document.getElementById('scrubPct').textContent = Math.round(foldProgress);
    document.getElementById('scrubFill').style.width = foldProgress + '%';
    if (foldProgress >= 100) {
      isPlaying = false;
      document.getElementById('playBtn').textContent = '▶ Auto Play';
      document.getElementById('playBtn').classList.remove('playing');
    }
  }

  updateSpring(dt);
  drawChain();
  drawEnergy();
  updateDiagnostics();
  updatePhaseBadge();

  playRaf = requestAnimationFrame(animLoop);
}

// Controls
function onScrub(val) {
  foldProgress = parseFloat(val);
  document.getElementById('scrubPct').textContent = Math.round(val);
  document.getElementById('scrubFill').style.width = val + '%';
}

function togglePlay() {
  isPlaying = !isPlaying;
  const btn = document.getElementById('playBtn');
  if (isPlaying) {
    if (foldProgress >= 99) { foldProgress = 0; lastTs = null; }
    btn.textContent = '⏸ Pause';
    btn.classList.add('playing');
  } else {
    btn.textContent = '▶ Auto Play';
    btn.classList.remove('playing');
  }
}

function toggleChaperone() {
  chaperoneOn = !chaperoneOn;
  const btn = document.getElementById('chapBtn');
  btn.textContent = chaperoneOn ? '⬡ Chaperones: ON' : '⬡ Chaperones: OFF';
  btn.classList.toggle('off', !chaperoneOn);
  stuckAt = -1;
  if (!chaperoneOn) showNotif('⚠ Chaperones disabled — misfolding risk elevated!');
  else showNotif('✓ Chaperones active — folding pathway stabilized');
}

function triggerMutation() {
  mutationActive = !mutationActive;
  document.getElementById('mutBanner').classList.toggle('visible', mutationActive);
  if (mutationActive) {
    showNotif('⚠ Point mutation triggered — amyloid aggregation pathway active!', 4000);
  } else {
    showNotif('✓ Mutation cleared — wild-type sequence restored');
  }
}

function toggleXray() {
  xrayOn = !xrayOn;
  const btn = document.getElementById('xrayBtn');
  btn.classList.toggle('on', xrayOn);
  document.getElementById('xrayOverlay').classList.toggle('active', xrayOn);
  showNotif(xrayOn ? '◎ X-Ray Vision: revealing hydrophobic core' : '◎ X-Ray Vision: OFF');
}

function resetSim() {
  foldProgress = 0;
  mutationActive = false;
  chaperoneOn = true;
  xrayOn = false;
  isPlaying = false;
  stuckAt = -1;
  jitterOffset = 0;
  document.getElementById('foldScrubber').value = 0;
  document.getElementById('scrubPct').textContent = '0';
  document.getElementById('scrubFill').style.width = '0%';
  document.getElementById('playBtn').textContent = '▶ Auto Play';
  document.getElementById('playBtn').classList.remove('playing');
  document.getElementById('chapBtn').textContent = '⬡ Chaperones: ON';
  document.getElementById('chapBtn').classList.remove('off');
  document.getElementById('xrayBtn').classList.remove('on');
  document.getElementById('xrayOverlay').classList.remove('active');
  document.getElementById('mutBanner').classList.remove('visible');
  initNodes();
  showNotif('↺ Simulation reset to unfolded state');
}

// ============================================================
// INIT
// ============================================================
window.addEventListener('load', () => {
  initNodes();
  requestAnimationFrame(animLoop);

  if (typeof $3Dmol !== 'undefined') {
    initHeroViewer();
    const labEl = document.getElementById('lab');
    let labLoaded = false;
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting && !labLoaded) {
        labLoaded = true;
        initLabViewer('1A3N');
        observer.disconnect();
      }
    }, { threshold: 0.1 });
    observer.observe(labEl);
  } else {
    console.warn('3Dmol not loaded');
    showLoading(false);
  }
});
</script>
</body>
</html>